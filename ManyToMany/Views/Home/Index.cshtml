@{
    ViewData["Title"] = "Home";
}

<div id="example">
    <div class="k-d-flex k-flex-wrap">
        <div class="k-flex-grow">
            <h4 class="mb-sm">Available Products</h4>
            <div id="inStockProductsGrid"></div>
        </div>
        <div class="k-flex-grow">
            <h4 class="mb-sm">Not Available Products</h4>
            <div id="discontinuedGrid"></div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    (function () {
        if (!window.kendo) {
            console.error("Kendo is not loaded. Check _Layout.cshtml script order.");
            return;
        }

        // Placeholder row must exist before any dataBound can run.
        var tr = { ProductID: 999, ProductName: "Placeholder", UnitPrice: "Placeholder", dummy: true };

        $(function () {
            var crudServiceBaseUrl = "https://demos.telerik.com/service/v2/core";
            var inStockData = [], discontinuedData = [];

            var discontinuedDS = new kendo.data.DataSource({
                data: discontinuedData,
                schema: { model: { id: "ProductID" } },
                pageSize: 10
            });

            var inStockDS = new kendo.data.DataSource({
                data: inStockData,
                schema: { model: { id: "ProductID" } },
                pageSize: 10
            });

            $.ajax({
                type: "GET",
                url: crudServiceBaseUrl + "/Products",
                success: function (data) {
                    data.forEach(function (item) {
                        item.Discontinued === false ? inStockData.push(item) : discontinuedData.push(item);
                    });
                    discontinuedDS.data(discontinuedData);
                    inStockDS.data(inStockData);
                },
                error: function (xhr, status, err) {
                    console.error("Products request failed:", status, err);
                }
            });

            // create grids
            $("#inStockProductsGrid").kendoGrid({
                dataSource: inStockDS,
                pageable: true,
                height: 400,
                width: 550,
                columns: [
                    { draggable: true, width: "40px" },
                    { field: "ProductName", title: "Product Name", width: "200px" },
                    { field: "UnitPrice", title: "Unit Price", format: "{0:c}", width: "140px" },
                    {
                        field: "Discontinued", title: "In Stock",
                        template: "<span id='badge_#=ProductID#' class='badgeTemplate'></span>",
                        attributes: { style: "text-align: center;" },
                        width: "130px"
                    }],
                dataBound: onDataBound,
                navigatable: true,
                reorderable: { rows: true },
                rowReorder: onRowReordered
            });

            $("#discontinuedGrid").kendoGrid({
                dataSource: discontinuedDS,
                pageable: true,
                height: 400,
                width: 550,
                columns: [
                    { draggable: true, width: "40px" },
                    { field: "ProductName", title: "Product Name", width: "200px" },
                    { field: "UnitPrice", title: "Unit Price", format: "{0:c}", width: "140px" },
                    {
                        field: "Discontinued", title: "In Stock",
                        template: "<span id='badge_#=ProductID#' class='badgeTemplate'></span>",
                        attributes: { style: "text-align: center;" },
                        width: "130px"
                    }],
                dataBound: onDataBound,
                navigatable: true,
                reorderable: { rows: true },
                rowReorder: onRowReordered
            });

            // Setup cross-grid drag & drop. Called after grids are created and also from onDataBound so targets/draggables stay in sync.
            function setupCrossGridDragDrop() {
                var inGrid = $("#inStockProductsGrid").data("kendoGrid");
                var discGrid = $("#discontinuedGrid").data("kendoGrid");
                if (!inGrid || !discGrid) return;

                // Remove any previous draggable/dropTarget instances (defensive)
                try {
                    inGrid.table.find("tbody").each(function () {
                        var existing = $(this).data("kendoDraggableInstance");
                        if (existing && existing.destroy) existing.destroy();
                    });
                    discGrid.table.find("tbody").each(function () {
                        var existing = $(this).data("kendoDropTargetInstance");
                        if (existing && existing.destroy) existing.destroy();
                    });
                } catch (ignore) {}

                // make rows draggable (group same for both grids)
                inGrid.table.kendoDraggable({
                    filter: "tbody > tr",
                    group: "gridRows",
                    hint: function (e) {
                        // clone the row as hint
                        return e.clone().css({ "background": "#fff", "box-shadow": "0 2px 6px rgba(0,0,0,0.2)" });
                    }
                });

                discGrid.table.kendoDraggable({
                    filter: "tbody > tr",
                    group: "gridRows",
                    hint: function (e) {
                        return e.clone().css({ "background": "#fff", "box-shadow": "0 2px 6px rgba(0,0,0,0.2)" });
                    }
                });

                // each grid table accepts drops from the other grid
                [inGrid, discGrid].forEach(function (targetGrid) {
                    targetGrid.table.kendoDropTarget({
                        group: "gridRows",
                        dragenter: function () {
                            targetGrid.table.addClass("k-grid-drop-target");
                        },
                        dragleave: function () {
                            targetGrid.table.removeClass("k-grid-drop-target");
                        },
                        drop: function (ev) {
                            targetGrid.table.removeClass("k-grid-drop-target");
                            // identify dragged row and its source grid
                            var draggable = ev.draggable;
                            var draggedRow = draggable.currentTarget || draggable.element;
                            var sourceGrid = draggedRow.closest(".k-grid").data("kendoGrid");
                            if (!sourceGrid) return;

                            var sourceItem = sourceGrid.dataItem(draggedRow);
                            if (!sourceItem || sourceItem.dummy) return; // ignore placeholders

                            // remove from source and add to target at end
                            // convert to plain object to avoid references to removed DS models
                            var plain = sourceItem.toJSON ? sourceItem.toJSON() : $.extend({}, sourceItem);
                            sourceGrid.dataSource.remove(sourceItem);
                            targetGrid.dataSource.add(plain);

                            // if source became empty, ensure placeholder present
                            if (sourceGrid.dataSource.view().length === 0) {
                                sourceGrid.dataSource.add(tr);
                            }

                            // remove placeholder from target if present
                            var placeholder = targetGrid.dataSource.get(tr.ProductID);
                            if (placeholder) targetGrid.dataSource.remove(placeholder);
                        }
                    });
                });
            }

            function onDataBound(e) {
                var grid = this;

                // Defensive: ensure dataItem exists (empty rows may not have dataItem)
                if (grid.dataSource.get && grid.dataSource.get(tr.ProductID) && grid.dataSource.view().length > 1) {
                    grid.dataSource.remove(grid.dataSource.get(tr.ProductID));
                }

                if (grid.dataSource.view().length === 0) {
                    grid.dataSource.add(tr);
                }

                grid.table.find("tr").each(function () {
                    var dataItem = grid.dataItem(this);
                    if (!dataItem) return;
                    var themeColor = dataItem.Discontinued ? 'error' : 'success';
                    var text = dataItem.Discontinued ? 'not available' : 'available';

                    $(this).find(".badgeTemplate").kendoBadge({
                        themeColor: themeColor,
                        text: text
                    });
                });

                // Re-setup drag/drop targets after rows change
                setupCrossGridDragDrop();
            }

            function onRowReordered(ev) {
                var grid = ev.sender, dataSource = grid.dataSource, externalGrid, externalDataItem;

                if (ev.oldIndex === -1) { // Row dropped from external grid
                    ev.preventDefault();
                    externalGrid = ev.row.parents(".k-grid").data("kendoGrid");
                    externalDataItem = externalGrid.dataItem(ev.row);

                    if (!externalDataItem.dummy) {
                        externalDataItem.Discontinued = !externalDataItem.Discontinued;
                        externalGrid.dataSource.remove(externalDataItem);
                        dataSource.insert(ev.newIndex, externalDataItem.toJSON());

                        var dummyRow = dataSource.get(tr.ProductID);
                        if (dummyRow) dataSource.remove(dummyRow);
                    }
                }

                if (externalGrid && externalGrid.dataSource.total() === 0) {
                    externalGrid.dataSource.add(tr);
                }
            }

            // initial setup once grids are created
            setupCrossGridDragDrop();
        });
    })();
</script>
}